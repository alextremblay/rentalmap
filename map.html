<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Products List | AppStrap Bootstrap Theme by Themelize.me</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Bootstrap v4.2.1 CSS via CDN -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css">

    <!-- Plugins required on all pages NOTE: Additional non-required plugins are loaded ondemand as of AppStrap 2.5 -->

    <!-- Theme style -->
    <link href="assets/css/theme-style.min.css" rel="stylesheet">

    <!-- Shop UI CSS - required if using shopping cart or any shop pages -->
    <link href="assets/css/theme-shop.min.css" rel="stylesheet">

    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>

    <!-- Your custom override -->
    <link href="assets/css/custom-style.css" rel="stylesheet">



    <!-- Optional: ICON SETS -->
    <!-- Iconset: Font Awesome 5.0.13 via CDN -->
    <link href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" rel="stylesheet">
    <!-- Iconset: flag icons - http://lipis.github.io/flag-icon-css/ -->
    <link href="assets/plugins/flag-icon-css/css/flag-icon.min.css" rel="stylesheet">
    <!-- Iconset: ionicons - http://ionicons.com/ -->
    <link href="http://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css" rel="stylesheet">
    <!-- Iconset: Linearicons - https://linearicons.com/free -->
    <link href="https://cdn.linearicons.com/free/1.0.0/icon-font.min.css" rel="stylesheet">
    <!-- Iconset: Lineawesome - https://icons8.com/articles/line-awesome -->
    <link href="https://maxcdn.icons8.com/fonts/line-awesome/1.1/css/line-awesome.min.css" rel="stylesheet">


    <!-- Le fav and touch icons - @todo: fill with your icons or remove, try https://realfavicongenerator.net -->
    <link rel="apple-touch-icon" sizes="180x180" href="assets/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/favicons/favicon-16x16.png">
    <link rel="manifest" href="assets/favicons/manifest.json">
    <link rel="shortcut icon" href="assets/favicons/favicon.ico">
    <meta name="msapplication-config" content="assets/favicons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">


    <!-- Google fonts -->
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700,300' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Rambla:400,700' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Calligraffitti' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Roboto+Slab:400,700' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Roboto:100,400,700' rel='stylesheet' type='text/css'>

    <!--Plugin: Retina.js (high def image replacement) - @see: http://retinajs.com/-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/retina.js/1.3.0/retina.min.js"></script>

    <!-- development version, includes helpful console warnings -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  </head>

  <!-- ======== @Region: body ======== -->
  <body class="page page-shop header-compact-sticky page-shop-list navbar-layout-navbar-below">

    <!-- ======== @Region: #header ======== -->
    <div id="header">
      <!--Branding & Navigation Region-->
      <div data-toggle="sticky">

        <div class="navbar navbar-expand-md">
          <!--everything within this div is collapsed on mobile-->
          <div class="navbar-main collapse bg-grey-dark navbar-dark">
            <div class="container clearfix">
              <!--main navigation-->
              <ul class="nav navbar-nav float-lg-left navbar-nav-flush dropdown-effect-fadeup">
                <!-- List Homepage -->
                <li class="nav-item"> <a href="list.html" class="nav-link">List</a> </li>

                <!-- Map Homepage -->
                <li class="nav-item"> <a href="map.html" class="nav-link">Map</a> </li>

              </ul>
            </div>
          </div>
          <!--/.navbar-collapse -->
        </div>
      </div>
    </div>

    <!-- ======== @Region: #page-header ======== -->
    <div id="page-header">
      <div class="container clearfix">
        <h3 class="mb-0 float-md-left">
          Home Rental Map
        </h3>
      </div>
    </div>

    <!-- ======== @Region: #map ======== -->
    <div id="map"></div>

    <!-- ======== @Region: #content ======== -->
    <div id="content" class="py-3 py-lg-6">
      <div id="app">

      </div>
    </div>

    <!--Hidden elements - excluded from jPanel Menu on mobile-->
    <div class="hidden-elements js-off-canvas-exclude">

      <!--@modal - login modal-->
      <div class="modal fade" id="login-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <form>
              <div class="modal-header bg-light">
                <h4 class="modal-title">
                  Login
                </h4>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
              </div>
              <div class="modal-body">
                <div class="form-group">
                  <label class="sr-only" for="login-user">Username</label>
                  <input type="text" id="login-user" class="form-control email" placeholder="User">
                </div>
                <div class="form-group mb-0">
                  <label class="sr-only" for="login-password">Password</label>
                  <input type="password" id="login-password" class="form-control password mb-1" placeholder="Password">
                </div>
              </div>
              <div class="modal-footer bg-light py-3">
                <div class="d-flex align-items-center">
                  <button type="button" class="btn btn-primary" id="login-button">Login</button>
                  <button type="button" class="btn btn-link ml-1" data-dismiss="modal" aria-hidden="true">Cancel</button>
                </div>
              </div>
            </form>
            <!-- /.modal-content -->
          </div>
        </div>
        <!-- /.modal-dialog -->
      </div>
      <!-- /.modal -->
    </div>

    <!--jQuery 3.3.1 via CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <!-- JS-Cookie via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>

    <script>
        var app = new Vue({
            el: '#app',
            data: {
                listings: []
            }
        });
        if (Cookies.get('token')) {
            var token = Cookies.get('token')
        }
        else {
            var token = '';
        }
        function login() {
            payload = {
                username: $('#login-user')[0].value,
                password: $('#login-password')[0].value
            };
            fetch('/login', {
                method: 'POST',
                headers: { "Content-Type": "application/json", },
                body: JSON.stringify(payload)
            })
                .then((result) => {
                    return result.json()
                })
                .then((json) => {
                    console.log(json);
                    $('#login-modal').modal('hide');
                    token = json['access_token'];
                    Cookies.set('token', token, { expires: 1 })
                    get_data(token)
                });
        }
        function get_data(token){
            fetch('/listings', {
                headers: {
                    "Authorization": 'Bearer '+token,
                    "Content-Type": "application/json",
                }
            })
                .then((response) => {
                    if (!response.ok) {
                        throw Error(response.statusText);
                    }
                    return response.json()
                })
                .then((json) => {
                      console.log(json);
                      app.listings = json;
                      $('#app').trigger('listings_received')
                }).catch((error) => {
                    console.log('got an error!');
                    console.log(error);
                    console.log('probably means our token expired. we should log in again');
                    $('#login-modal').modal('show');
            })
        }
    </script>

    <!-- Google Maps stuff -->
    <script>
          var map;
          function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
              center: {lat: 43.720836, lng: -79.379404},
              zoom: 13
            });
          }
          $('#app').on('listings_received', () => {
              console.log('looping through coords')
              for (let i = 0; i < app.listings.length; i++){
                  let coords = {
                      lat: app.listings[i].coordinates.lat,
                      lng: app.listings[i].coordinates.lon
                  }
                  let marker = new google.maps.Marker({
                    position: coords,
                    map: map,
                    title: app.listings[i]['street-name']
                  });
              }
          });
        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDV75BbmSjWkUSL0BeBFxpNQf79ggwigfI&callback=initMap"
        async defer></script>

    <!-- Popper 1.14.6 via CDN, needed for Bootstrap Tooltips & Popovers -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"></script>

    <!-- Bootstrap v4.2.1 JS via CDN -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"></script>

    <!-- JS plugins required on all pages NOTE: Additional non-required plugins are loaded ondemand as of AppStrap 2.5 To disable this and load plugin assets/ manually simple add data-plugins-manual=true to the body tag -->

    <!--Custom scripts & AppStrap API integration -->
    <script src="assets/js/custom-script.js"></script>
    <!--AppStrap scripts mainly used to trigger libraries/plugins -->
    <script src="assets/js/script.min.js"></script>

    <script>
      $('#login-button').click(login);
      if(token === ''){
          $('#login-modal').modal('show');
      }
      else {
          get_data(token)
      }
    </script>

  </body>
</html>